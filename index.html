<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>BBCSS Command Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{height:100%;margin:0;background:#0b0f1a;color:#e5e7eb;font-family:Arial,sans-serif;}

/* ================= LOGIN ================= */
#loginScreen{
  position:fixed;inset:0;
  background:radial-gradient(circle at top,#020617,#000);
  display:flex;align-items:center;justify-content:center;
  z-index:10000;
}
.login-box{
  width:360px;background:#0f172a;padding:28px;
  border-radius:10px;border:1px solid #1f2937;
  text-align:center;
}
.login-box img{width:140px;margin-bottom:16px;}
.login-box input{
  width:100%;padding:10px;margin-bottom:10px;
  background:#020617;border:1px solid #1f2937;color:#e5e7eb;
}
.login-box button{
  width:100%;padding:10px;
  background:#2563eb;border:none;color:#fff;
  font-weight:600;cursor:pointer;
}
#loginError{color:#ef4444;font-size:12px}

/* ================= HEADER ================= */
#header{
  position:relative;height:64px;background:#020617;
  border-bottom:1px solid #1f2937;
  display:none;z-index:1000;
}
#menuBtn{
  position:absolute;left:18px;top:50%;
  transform:translateY(-50%);
  background:none;border:none;color:#e5e7eb;
  font-size:22px;cursor:pointer;
}
#headerCenter{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  display:flex;align-items:center;gap:12px;
}
.logo{height:40px;}
.header-title{font-size:18px;font-weight:600;}

/* ================= MENU ================= */
#menuPanel{
  position:fixed;top:64px;left:-260px;
  width:240px;height:calc(100% - 64px);
  background:#020617;border-right:1px solid #1f2937;
  padding:14px;transition:left .25s ease;
  z-index:999;display:none;
}
#menuPanel.open{left:0;}
#menuPanel h3{margin:0 0 12px;font-size:13px;color:#9ca3af;}
#menuPanel button{
  width:100%;padding:8px;margin-bottom:8px;
  background:#020617;border:1px solid #1f2937;
  color:#e5e7eb;text-align:left;cursor:pointer;
}
#menuPanel button:hover{background:#2563eb;border-color:#2563eb;}

/* ================= LAYOUT ================= */
.page{display:none;}
.page.active{display:block;}
.container{display:flex;height:calc(100vh - 64px - 54px);}

/* ================= SIDEBAR ================= */
#sidebar{
  width:420px;background:#0f172a;
  border-right:1px solid #1f2937;
  padding:14px;overflow-y:auto;
}
.section{margin-bottom:14px;}
.section h3{
  font-size:13px;padding:6px 8px;background:#020617;
  border-left:4px solid #2563eb;margin:0 0 6px;
}
.section .content{
  background:#0b1220;padding:8px;
  border:1px solid #1f2937;font-size:13px;
}
.empty{color:#6b7280}

/* ================= TABLE ================= */
table{width:100%;border-collapse:collapse;font-size:12px;}
th,td{padding:5px;border:1px solid #1f2937;}
th{background:#020617;}
.on-duty{background:rgba(16,185,129,.15);}
.off-duty{background:rgba(245,158,11,.15);}
.absconding{background:rgba(239,68,68,.25);font-weight:bold;}

/* ================= MAP ================= */
#map{flex:1;}

/* ================= SUMMARY ================= */
#summaryPanel{
  position:fixed;bottom:0;left:0;right:0;height:54px;
  background:#020617;border-top:1px solid #1f2937;
  display:none;justify-content:space-around;align-items:center;
}
.summary-item{text-align:center;font-size:12px;}
.summary-item .label{color:#9ca3af;font-size:11px;}
.summary-item .value{font-size:16px;font-weight:bold;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <img src="https://lh3.googleusercontent.com/d/12Xf4kpshWWpf-TntBM7dCTNyemEWPeUt">
    <h3>BBCSS Command Center</h3>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginError"></p>
  </div>
</div>

<!-- MENU -->
<div id="menuPanel">
  <h3>MENU</h3>
  <button onclick="showPage('map')"> Command Center</button>
  <button onclick="showPage('site')"> Unit Details</button>
</div>

<!-- HEADER -->
<div id="header">
  <button id="menuBtn" onclick="toggleMenu()">☰</button>
  <div id="headerCenter">
    <img src="https://lh3.googleusercontent.com/d/12Xf4kpshWWpf-TntBM7dCTNyemEWPeUt" class="logo">
    <div class="header-title">BBCSS Command Center</div>
  </div>
</div>

<!-- MAP PAGE -->
<div id="page-map" class="page active">
  <div class="container">
    <div id="sidebar">
      <div class="section">
        <h3>Site Details</h3>
        <div id="sitePanel" class="content empty">Click a site pin</div>
      </div>
    </div>
    <div id="map"></div>
  </div>
</div>

<!-- SITE DETAILS PAGE -->
<div id="page-site" class="page">
  <div class="container">

    <!-- LEFT PANEL -->
    <div id="sidebar">

      <!-- SEARCH + DROPDOWN -->
      <div class="section">
        <h3>Select Site</h3>
        <div class="content">
          <input
            id="siteSearch"
            placeholder="Search site..."
            style="width:100%;padding:8px;margin-bottom:6px"
            oninput="filterSiteDropdown()"
          >

          <select
            id="siteSelect"
            style="width:100%;padding:8px"
            onchange="loadSiteDetails(this.value)"
          >
            <option value="">Select a site</option>
          </select>
        </div>
      </div>

      <!-- SITE INFO (VERTICAL) -->
      <div class="section">
        <h3>Site Information</h3>
        <div id="siteInfo" class="content empty">
          Select a site
        </div>
      </div>

      <!-- REQUIRED STRENGTH -->
      <div class="section">
        <h3>Required Strength</h3>
        <div id="siteStrength" class="content empty"></div>
      </div>
      
      <div class="section">
  <h3>Latest Training</h3>
  <div id="siteTraining" class="content empty">
    No training data
  </div>
</div>


    </div>

    <!-- RIGHT PANEL -->
    <div style="flex:1;padding:14px;overflow:auto">
      <div class="section">
        <h3>Guards at Site</h3>
        <div id="siteGuards" class="content empty">
          No site selected
        </div>
      </div>
    </div>

  </div>
</div>


<!-- SUMMARY -->
<div id="summaryPanel">
  <div class="summary-item"><div class="label">Sites</div><div id="sumSites" class="value">0</div></div>
  <div class="summary-item"><div class="label">Guards</div><div id="sumGuards" class="value">0</div></div>
</div>

<script>
let navStart = null;
let navEnd = null;
let siteDetails = [];
let selectedSiteDetails = null;
let trainingData = [];



/* ================= AUTH ================= */
const USERS=[{u:"admin",p:"bbcss123"},{u:"ops",p:"ops123"}];

function login(){
  if(!USERS.find(x=>x.u===username.value && x.p===password.value)){
    loginError.innerText="Invalid credentials";return;
  }
  sessionStorage.setItem("bbcss","1");
  loginScreen.style.display="none";
  header.style.display="block";
  menuPanel.style.display="block";
  summaryPanel.style.display="flex";

  initMap();
  loadSiteMaster(); // ✅ ADD THIS

}
if(sessionStorage.getItem("bbcss")==="1"){
  loginScreen.style.display="none";
  header.style.display="block";
  menuPanel.style.display="block";
  summaryPanel.style.display="flex";
  initMap();         // ✅ ADD
  loadSiteMaster();  // ✅ ADD
}
  
/* ================= MENU ================= */
function toggleMenu(){menuPanel.classList.toggle("open");}
function showPage(p){
  document.querySelectorAll(".page").forEach(pg=>pg.classList.remove("active"));
  document.getElementById("page-"+p).classList.add("active");
  menuPanel.classList.remove("open");
}

/* ================= DATA ================= */
const SHEET_ID="1sp0zxqkeBLyNLMcLgnmRRcwAm_AiXLI3XGSCvWvWnoM";
const SITES_URL=`https://opensheet.elk.sh/${SHEET_ID}/Sites`;
const GUARDS_URL=`https://opensheet.elk.sh/${SHEET_ID}/Guards`;
const SITE_DETAILS_URL =`https://opensheet.elk.sh/${SHEET_ID}/Site_Details`;
const TRAINING_URL = `https://opensheet.elk.sh/${SHEET_ID}/Training`;



let map,sites=[],guards=[],markers=[];

/* ================= MAP ================= */
async function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:17.5,lng:78.4},zoom:7
  });
  sites=await fetch(SITES_URL).then(r=>r.json());
  guards=await fetch(GUARDS_URL).then(r=>r.json());
  renderMarkers();
}

function renderMarkers(){
  markers.forEach(m=>m.setMap(null));markers=[];
  sites.forEach(site=>{
    const m=new google.maps.Marker({
      map,position:{lat:+site.Latitude,lng:+site.Longitude},title:site.Name
    });
    m.addListener("click",()=>showSite(site));
    markers.push(m);
  });
  sumSites.innerText=sites.length;
  sumGuards.innerText=guards.length;
}

function showSite(site){
  // Selection logic
  if (!navStart) {
    navStart = site;
  } else if (!navEnd && site !== navStart) {
    navEnd = site;
  }

  const list = guards.filter(g => g["Site Name"] === site.Name);

  sitePanel.innerHTML = `
    <b>${site.Name}</b><br><br>

    <div style="font-size:12px;margin-bottom:8px">
      <b>Selected Route</b><br>
      Start: ${navStart ? navStart.Name : "—"}<br>
      End: ${navEnd ? navEnd.Name : "—"}
    </div>

    <button
      ${navStart && navEnd ? "" : "disabled"}
      style="
        width:100%;
        padding:8px;
        margin-bottom:6px;
        background:${navStart && navEnd ? "#16a34a" : "#374151"};
        border:none;
        color:#fff;
        font-weight:600;
        cursor:pointer;
      "
      onclick="navigatePinToPin()"
    >
      Navigate Unit A to Unit B
    </button>

    <button
      ${navEnd ? "disabled" : ""}
      style="
        width:100%;
        padding:8px;
        margin-bottom:6px;
        background:#2563eb;
        border:none;
        color:#fff;
        font-weight:600;
        cursor:pointer;
      "
      onclick="navigateFromCurrent()"
    >
      Navigate From Current Location
    </button>

    <button
      style="
        width:100%;
        padding:6px;
        background:#1f2937;
        border:1px solid #374151;
        color:#9ca3af;
        cursor:pointer;
        font-size:12px;
      "
      onclick="resetNavigation()"
    >
      Reset Navigation
    </button>

    ${guardsTable(list)}
  `;
}


  function navigatePinToPin(){
  if (!navStart || !navEnd) return;

  const url =
    `https://www.google.com/maps/dir/?api=1` +
    `&origin=${navStart.Latitude},${navStart.Longitude}` +
    `&destination=${navEnd.Latitude},${navEnd.Longitude}`;

  window.open(url, "_blank");
}

function navigateFromCurrent(){
  if (!navStart) return;

  const target = navEnd || navStart;

  const url =
    `https://www.google.com/maps/dir/?api=1` +
    `&destination=${target.Latitude},${target.Longitude}`;

  window.open(url, "_blank");
}

function resetNavigation(){
  navStart = null;
  navEnd = null;
  sitePanel.innerHTML =
    "<div class='empty'>Navigation cleared. Select a site.</div>";
}

  function openDirections(lat, lng){
  const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
  window.open(url, "_blank");
}


function guardsTable(list){
  if(!list.length) return "<div class='empty'>No guards</div>";
  return `<table>
    <tr><th>#</th><th>Name</th><th>ID</th><th>Rank</th><th>Status</th></tr>
    ${list.map((g,i)=>`
      <tr class="${g["Duty Status"]==="On Duty"?"on-duty":g["Duty Status"]==="Off Duty"?"off-duty":"absconding"}">
        <td>${i+1}</td>
        <td>${g["Guard Name"]}</td>
        <td>${g["Guard ID"]||""}</td>
        <td>${g.Rank||""}</td>
        <td>${g["Duty Status"]}</td>
      </tr>`).join("")}
  </table>`;
}
async function loadSiteMaster(){
  siteDetails = await fetch(SITE_DETAILS_URL).then(r=>r.json());
  trainingData = await fetch(TRAINING_URL).then(r=>r.json());

  siteDetails.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s["Unit Name"];
    opt.textContent = s["Unit Name"];
    siteSelect.appendChild(opt);
  });
}

function filterSiteDropdown(){
  const q = siteSearch.value.toLowerCase();
  [...siteSelect.options].forEach(o=>{
    if(!o.value) return;
    o.style.display = o.textContent.toLowerCase().includes(q)
      ? "block" : "none";
  });
}

function loadSiteDetails(unitName){
  selectedSiteDetails = siteDetails.find(
    s => s["Unit Name"] === unitName
  );
  if(!selectedSiteDetails) return;

  renderSiteInfo(selectedSiteDetails);
  renderStrength(selectedSiteDetails);
  renderGuardDetails(unitName);
  renderTraining(unitName);

}

function renderSiteInfo(site){
  siteInfo.innerHTML = `
    <div><b>Parent Account:</b> ${site["Parent Account Name"]}</div>
    <div><b>Unit Name:</b> ${site["Unit Name"]}</div>
    <div><b>Unit Code:</b> ${site["Unit Code"]}</div>
    <div><b>Client POC:</b> ${site["Unit Client POC"]}</div>
    <div><b>POC Phone:</b> ${site["Unit Client POC Phone"]}</div>
    <div><b>Escalation:</b> ${site["Escalation Contact"]}</div>
    <div><b>Escalation Phone:</b> ${site["Escalation Contact Phone"]}</div>
    <div><b>Email:</b> ${site["Escalation Contact Email"]}</div>
    <div><b>Field Officer:</b> ${site["Field Officer"]}</div>
    <div><b>FO Phone:</b> ${site["Field Officer Number"]}</div>
    <div><b>Shift Pattern:</b> ${site["Shift Pattern"]}</div>
    <div><b>Shift Change:</b> ${site["Shift Change Time"]}</div>
  `;
}

function renderStrength(site){
  siteStrength.innerHTML = `
    <table>
      <tr>
        <th>T/G</th><th>S/G</th><th>HS/G</th><th>L/G</th>
        <th>S/S</th><th>ASO</th><th>H/K</th><th>Misc</th>
      </tr>
      <tr>
        <td>${site["T/G"]||0}</td>
        <td>${site["S/G"]||0}</td>
        <td>${site["HS/G"]||0}</td>
        <td>${site["L/G"]||0}</td>
        <td>${site["S/S"]||0}</td>
        <td>${site["ASO"]||0}</td>
        <td>${site["H/K"]||0}</td>
        <td>${site["Misc"]||0}</td>
      </tr>
    </table>
  `;
}

function renderGuardDetails(unitName){
  const list = guards.filter(g => g["Site Name"] === unitName);

  siteGuards.innerHTML = `
    <table>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Shift</th>
        <th>Status</th>
        <th>Phone</th>
        <th>Remark</th>
      </tr>
      ${list.map(g=>`
        <tr>
          <td>${g.Rank}</td>
          <td>${g["Guard Name"]}</td>
          <td>${g.Shift}</td>
          <td>${g["Duty Status"]}</td>
          <td>${g.Phone}</td>
          <td>${g["OT Reason"] || g["Last Update"] || ""}</td>
        </tr>
      `).join("")}
    </table>
  `;
}
  function renderTraining(unitName){
  const rows = trainingData
    .filter(t => t["Site.Name"] === unitName || t["Site Name"] === unitName)
    .sort((a,b)=> new Date(b["Training Date"]) - new Date(a["Training Date"]));

  if (!rows.length){
    siteTraining.innerHTML =
      "<div class='empty'>No training records</div>";
    return;
  }

  const latest = rows[0];

  siteTraining.innerHTML = `
    <table>
      <tr>
        <th>Date</th>
        <th>Trainer</th>
        <th>Image</th>
      </tr>
      <tr>
        <td>${latest["Training Date"]}</td>
        <td>${latest["Trainer Name"]}</td>
        <td>
          <a href="${latest["Training image url"]}" target="_blank">
            View
          </a>
        </td>
      </tr>
    </table>
  `;
}


</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyConhuaK9NwmTVHZ5yk7n54uuFTzqtG2wI"></script>
</body>
</html>







