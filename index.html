<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>BBCSS Command Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
  height:100%;
  margin:0;
  background:#0b0f1a;
  color:#e5e7eb;
  font-family:Arial,sans-serif;
}

/* HEADER */
#header{
  height:64px;
  background:#020617;
  display:flex;
  align-items:center;
  padding:0 18px;
  border-bottom:1px solid #1f2937;
}
.logo{height:40px;margin-right:14px;}
.header-title{
  flex:1;
  text-align:center;
  font-size:18px;
  font-weight:600;
}

/* LOGIN */
#loginScreen{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,#020617,#000);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.login-box{
  width:360px;
  background:#0f172a;
  padding:32px;
  border-radius:10px;
  border:1px solid #1f2937;
  text-align:center;
}
.login-logo{width:140px;margin-bottom:18px;}
.login-box input{
  width:100%;
  padding:11px;
  margin-bottom:12px;
  background:#020617;
  border:1px solid #1f2937;
  border-radius:6px;
  color:#e5e7eb;
}
.login-box button{
  width:100%;
  padding:11px;
  background:#2563eb;
  border:none;
  border-radius:6px;
  color:#fff;
  font-weight:600;
}
#loginError{color:#ef4444;font-size:12px}

/* LAYOUT */
.container{
  display:flex;
  height:calc(100vh - 64px - 54px);
}

/* SIDEBAR */
#sidebar{
  width:420px;
  background:#0f172a;
  border-right:1px solid #1f2937;
  padding:14px;
  overflow-y:auto;
}
.section{margin-bottom:14px;}
.section h3{
  font-size:13px;
  padding:6px 8px;
  background:#020617;
  border-left:4px solid #2563eb;
  margin:0 0 6px;
  text-transform:uppercase;
}
.section .content{
  background:#0b1220;
  padding:8px;
  border:1px solid #1f2937;
  font-size:13px;
}
button{
  width:100%;
  padding:6px;
  background:#020617;
  border:1px solid #2563eb;
  color:#e5e7eb;
  cursor:pointer;
}
.empty{color:#6b7280}

/* TRAINING */
.training-card{display:flex;flex-direction:column;gap:10px;}
.training-meta{display:flex;justify-content:space-between;}
.training-meta .label{font-size:11px;color:#9ca3af;}
.training-meta .value{font-weight:600;}
.training-image img{
  width:100%;
  border-radius:6px;
  border:1px solid #1f2937;
}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:12px;}
th,td{padding:5px;border:1px solid #1f2937;}
th{background:#020617;}
.on-duty{background:rgba(16,185,129,0.15);}
.off-duty{background:rgba(245,158,11,0.15);}
.absconding{background:rgba(239,68,68,0.25);font-weight:bold;}

/* MAP */
#map{flex:1;}

/* SUMMARY */
#summaryPanel{
  position:fixed;
  bottom:0;left:0;right:0;
  height:54px;
  background:#020617;
  border-top:1px solid #1f2937;
  display:flex;
  justify-content:space-around;
  align-items:center;
}
.summary-item{text-align:center;font-size:12px;}
.summary-item .label{color:#9ca3af;font-size:11px;}
.summary-item .value{font-size:16px;font-weight:bold;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <img src="https://lh3.googleusercontent.com/d/12Xf4kpshWWpf-TntBM7dCTNyemEWPeUt" class="login-logo">
    <h3>BBCSS Command Center</h3>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginError"></p>
  </div>
</div>

<!-- HEADER -->
<div id="header">
  <img src="https://lh3.googleusercontent.com/d/12Xf4kpshWWpf-TntBM7dCTNyemEWPeUt" class="logo">
  <div class="header-title">BBCSS Command Center</div>
</div>

<div class="container">
  <div id="sidebar">
    <div class="section">
      <h3>STATE VIEW</h3>
      <div class="content">
        <button onclick="filterState('ALL')">All States</button><br><br>
        <button onclick="filterState('Telangana')">Telangana</button><br><br>
        <button onclick="filterState('Karnataka')">Karnataka</button>
      </div>
    </div>
    <div id="sitePanel" class="empty">Click a site pin</div>
  </div>
  <div id="map"></div>
</div>

<div id="summaryPanel">
  <div class="summary-item"><div class="label">Sites</div><div id="sumSites" class="value">0</div></div>
  <div class="summary-item"><div class="label">Guards</div><div id="sumGuards" class="value">0</div></div>
  <div class="summary-item"><div class="label">On Duty</div><div id="sumOn" class="value">0</div></div>
  <div class="summary-item"><div class="label">Off Duty</div><div id="sumOff" class="value">0</div></div>
  <div class="summary-item"><div class="label">Absconding</div><div id="sumAbs" class="value">0</div></div>
</div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = ""https://oypejznuvzghggcuksys.supabase.co"";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGVqem51dnpnaGdnY3Vrc3lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODA0NzMsImV4cCI6MjA4MzE1NjQ3M30.WVAt-887556vrs2uSvzCkZU95TkPjXpe2BEwOHccl0o";

  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );
</script>

<script>
/* LOGIN */
const USERS=[{user:"admin",pass:"bbcss123"},{user:"ops",pass:"ops123"}];
function login(){
  if(!USERS.find(x=>x.user===username.value && x.pass===password.value)){
    loginError.innerText="Invalid credentials"; return;
  }
  sessionStorage.setItem("bbcss","1");
  loginScreen.style.display="none";
  start();
}
if(sessionStorage.getItem("bbcss")==="1") loginScreen.style.display="none";

/* DATA */

const TRAINING_URL=`https://opensheet.elk.sh/${SHEET_ID}/Training`;

let map,allSites=[],guards=[],trainings=[],markers=[],currentSites=[];
let lastClickedSite=null,startPoint=null,endPoint=null;

/* MAP */
function start(){ if(!window.google) return setTimeout(start,300); initMap(); }
async function initMap(){
  // LOAD SITES
const { data: sitesData, error: sitesError } =
  await supabaseClient.from('sites').select('*');

if (sitesError) {
  console.error(sitesError);
  return;
}
allSites = sitesData.map(s => ({
  Name: s.site_name,
  Latitude: s.latitude,
  Longitude: s.longitude,
  State: "ALL", // placeholder (we'll improve later)
  site_code: s.site_code
}));

// LOAD GUARDS (from view)
const { data: guardsData, error: guardsError } =
  await supabaseClient.from('guards_with_sites').select('*');

if (guardsError) {
  console.error(guardsError);
  return;
}
guards = guardsData.map(g => ({
  "Guard Name": g.name,
  Rank: g.rank,
  "Duty Status": g.status,
  Name: g.site_name
}));

trainings = []; // keep empty for now

}

/* HELPERS */
function guardsTable(list){
  if(!list.length) return "<div class='empty'>No guards</div>";
  return `<table>
    <tr><th>#</th><th>Name</th><th>Rank</th><th>Status</th></tr>
    ${list.map((g,i)=>`
      <tr class="${g["Duty Status"]==="On Duty"?"on-duty":g["Duty Status"]==="Off Duty"?"off-duty":"absconding"}">
        <td>${i+1}</td>
        <td>${g["Guard Name"]}</td>
        <td>${g.Rank||"-"}</td>
        <td>${g["Duty Status"]}</td>
      </tr>`).join("")}
  </table>`;
}

/* FILTER */
function filterState(state){
  currentSites=state==="ALL"?allSites:allSites.filter(s=>s.State===state);
  markers.forEach(m=>m.setMap(null)); markers=[];
  currentSites.forEach(site=>{
    const m=new google.maps.Marker({
      map,position:{lat:+site.Latitude,lng:+site.Longitude},title:site.Name
    });
    m.addListener("click",()=>{
      lastClickedSite={lat:+site.Latitude,lng:+site.Longitude,name:site.Name};
      showSite(site);
    });
    markers.push(m);
  });
  updateSummary();
}

/* SITE PANEL */
function showSite(site){
  const siteGuards=guards.filter(g=>g.Name===site.Name);
  const training=trainings
    .filter(t=>t["Site.Name"]===site.Name)
    .sort((a,b)=>new Date(b["Training Date"])-new Date(a["Training Date"]))[0];

  sitePanel.innerHTML=`
  <div class="section"><h3>Site Details</h3><div class="content">
    <b>${site.Name}</b><br>
    ${site.ClientName||""}<br>
    ${site.ClientPhone||""}<br><br>
    ${site.SiteDescription||""}<br><br>
    ${site.ReferenceLink?`<a href="${site.ReferenceLink}" target="_blank" style="color:#60a5fa">Reference</a>`:""}
  </div></div>

  <div class="section"><h3>Last Training</h3>
    ${training?`
    <div class="content training-card">
      <div class="training-meta">
        <div><span class="label">Date</span><span class="value">${training["Training Date"]}</span></div>
        <div><span class="label">Type</span><span class="value">${training["TrainingType"]}</span></div>
      </div>
      <div class="training-image"><img src="${training["Training image url"]}"></div>
    </div>`:`<div class="content empty">No training record</div>`}
  </div>

  <div class="section"><h3>Route & Navigation</h3>
    <div class="content">
      <button onclick="startPoint=lastClickedSite">Set Start</button><br><br>
      <button onclick="endPoint=lastClickedSite">Set Destination</button><br><br>
      <button onclick="openRoute()">Open in Google Maps</button>
    </div>
  </div>

  <div class="section"><h3>Guards</h3>
    <div class="content">${guardsTable(siteGuards)}</div>
  </div>`;
}

/* ROUTE */
function openRoute(){
  if(!startPoint||!endPoint) return alert("Set start and destination");
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${startPoint.lat},${startPoint.lng}&destination=${endPoint.lat},${endPoint.lng}`);
}

/* SUMMARY */
function updateSummary(){
  const names=currentSites.map(s=>s.Name);
  const g=guards.filter(x=>names.includes(x.Name));
  sumSites.innerText=currentSites.length;
  sumGuards.innerText=g.length;
  sumOn.innerText=g.filter(x=>x["Duty Status"]==="On Duty").length;
  sumOff.innerText=g.filter(x=>x["Duty Status"]==="Off Duty").length;
  sumAbs.innerText=g.filter(x=>x["Duty Status"]==="Absconding").length;
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyConhuaK9NwmTVHZ5yk7n54uuFTzqtG2wI"></script>


</body>
</html>



